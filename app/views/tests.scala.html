@(
  testsSummary: TestsSummaryView, 
  tests: Seq[TestView], 
  configuration: Configuration, 
  testStatusOpt: Option[TestStatus], 
  nameOpt: Option[String], 
  groupOpt: Option[String],
  canRerun: Boolean, 
  pagination: PaginationData,
  sortOpt: Option[Sort],
  descendingOpt: Option[Boolean])(implicit flash: Flash, request: RequestHeader, globalViewContext: GlobalViewContext)

@scripts = {
  <script src="@routes.Assets.at("javascripts/tests.js")"></script>
  <script src="@routes.Assets.at("javascripts/pass-fail-pie-chart.js")"></script>
  <script src="@routes.Assets.at("javascripts/history-chart.js")"></script>
}

@css = {
  <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/tests.css")">
}

@testsPaginationWidget = { 
  @paginationWidget(pagination)((page, pageSize) => 
    routes.Application.tests(
      configuration = Some(configuration), 
      status = testStatusOpt, 
      name = nameOpt,
      group = groupOpt, 
      page = Some(page), 
      pageSize = Some(pageSize),
      sort = sortOpt,
      descending = descendingOpt)) 
}

@sortLink(sort: Sort) = {
  @if(sortOpt.getOrElse(Sort.Group) == sort) {
    @if(descendingOpt.getOrElse(false)) {
      <a class="sort-link" href="@routes.Application.tests(configuration = Some(configuration), status = testStatusOpt, name = nameOpt, group = groupOpt, sort = Some(sort))">
        <i class="fa fa-sort-desc"></i>
      </a> 
    } else {
      <a class="sort-link" href="@routes.Application.tests(configuration = Some(configuration), status = testStatusOpt, name = nameOpt, group = groupOpt, sort = Some(sort), descending = Some(true))">
        <i class="fa fa-sort-asc"></i>
      </a> 
    } 
  } else {
    <a class="sort-link" href="@routes.Application.tests(configuration = Some(configuration), status = testStatusOpt, name = nameOpt, group = groupOpt, sort = Some(sort))">
      <i class="fa fa-sort"></i>
    </a> 
  }
}

@main(if(globalViewContext.multipleConfigurationMode) "Tests: " + configuration else "Tests", "Tests", scripts = scripts, css = css) {

  <h2><img src="@routes.Assets.at("images/" + testsSummary.ballIcon)"/> Tests</h2>
  
    <div class="row">
    <div class="col-md-9">
      <table style="margin-top: 15px" class="table table-striped table-bordered table-hover">
        @if(globalViewContext.multipleConfigurationMode) {
          <tr>
            <td>Configuration</td>
            <td>
              <form id="configuration-form" action="@routes.Application.tests(configuration = Some(configuration), status = testStatusOpt, name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)" method="get">
                @for(name <- nameOpt) { <input name="name" value="@name" type="hidden"/> }
                @for(group <- groupOpt) { <input name="group" value="@group" type="hidden"/> }
                @for(status <- testStatusOpt) { <input name="status" value="@status" type="hidden"/> }
                <select id="configuration-select" class="form-control" name="configuration">
                  @for(otherConfiguration <- globalViewContext.configurations) {
                    <option value="@otherConfiguration" @if(configuration == otherConfiguration){selected}>@otherConfiguration</option>
                  }
                </select>
              </form>
            </td>
          </tr>
        }
        @for(group <- groupOpt) {
          <tr>
            <td>Group</td>
            <td>
              <!-- http://jsfiddle.net/7zkCU/14/ -->
              <span class="tag label label-info" style="margin-bottom: 0px">
                <span>@group</span>
                <a href="@routes.Application.tests(configuration = Some(configuration), status = testStatusOpt, name = nameOpt, group = None, sort = sortOpt, descending = descendingOpt)" style="opacity: 0.6;" title="Remove filter by group">
                  <i class="remove glyphicon glyphicon-remove-sign glyphicon-white"></i>
                </a> 
              </span>
            </td>
          </tr>
        }
        @if(testsSummary.passCount > 0){
          <tr>
            <td>Healthy</td>       
            <td><a href="@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Healthy), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)"><span class="badge badge-success">@testsSummary.passCount</span></a></td>
          </tr>
        }
        @if(testsSummary.warnCount > 0){
          <tr>          
            <td>Warning</td>
            <td><a href="@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Warning), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)"><span class="badge badge-warning">@testsSummary.warnCount</span></a></td>
          </tr>
        }
        @if(testsSummary.failCount > 0){
          <tr>
            <td>Broken</td>
            <td><a href="@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Broken), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)"><span class="badge badge-error">@testsSummary.failCount</span></a></td>
          </tr>
        }
        <tr>
          <td style="width: 100px;">Total</td>
          <td><a id="total-test-count" href="@routes.Application.tests(configuration = Some(configuration), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)"><span class="badge badge-inverse">@testsSummary.totalCount</span></a></td>
        </tr>
      </table>
    </div> <!-- col-md-9 -->
    <div class="col-md-3">
      <div id="pie-chart" style="margin-top: 6px; width: 200px; height: 200px"></div>
      <script>
        $(document).ready(function(){
          createPieChart("pie-chart",
            {
              pass: @testsSummary.passCount,
              warn: @testsSummary.warnCount,
              fail: @testsSummary.failCount,
            },
            {
              pass: "@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Healthy), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)",
              warn: "@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Warning), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)",
              fail: "@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Broken), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)",
            }
          );
        });
      </script>
    </div> <!-- col-md-3 -->
  </div> <!-- row -->

  <br/>

  <div class="panel-group">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a data-toggle="collapse" data-target="#collapseOne">
            Search Options
          </a>
        </h4>
      </div>
      <div id="collapseOne" class="panel-collapse collapse">
        <div class="panel-body">
          <form id="filter-form" role="form" action="@routes.Application.tests(configuration = Some(configuration), sort = sortOpt, descending = descendingOpt)">
             <div class="form-group">
               <label for="test-name-field">Test name</label>
               <input name="name" id="test-name-field" value="@{nameOpt.getOrElse("")}" class="form-control typeahead" type="text" placeholder="Test name"/>
             </div>
             <div class="form-group">
               <label for="group-name-field">Group</label>
               <input name="group" id="group-name-field" value="@{groupOpt.getOrElse("")}" class="form-control typeahead" type="text" placeholder="Group"/>
             </div>
             <input name="configuration" value="@configuration" type="hidden"/>
             <button id="filter-tests" type="submit" class="btn btn-default">Search</button>
          </form>
        </div>
      </div>
    </div>    
  </div>

  <br/>

  @if(tests.nonEmpty) {

  @if(canRerun) {
    <button style="margin-bottom: 12px" id="rerunSelected" type="button" class="btn btn-default" title="Rerun selected tests on Jenkins" onclick="performTestAction('@routes.CiController.rerunSelectedTests()')"><i class="glyphicon glyphicon-refresh"></i> Rerun Selected</button>
  }
  <button style="margin-bottom: 12px" id="deleteSelected" type="button" class="btn btn-default" title="Mark selected tests as deleted" onclick="performTestAction('@routes.Application.deleteTests()')"><i class="glyphicon glyphicon-trash"></i> Mark selected tests as deleted</button>
  <div style="clear: both;"></div>

  @testsPaginationWidget
  
  <ul class="nav nav-tabs">
    <li @if(testStatusOpt.isEmpty){ class="active" }>
      <a href="@routes.Application.tests(configuration = Some(configuration), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)">All</a>
    </li>
    @if(testsSummary.passCount > 0) {
      <li @if(testStatusOpt == Some(TestStatus.Healthy)){ class="active" }>
        <a href="@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Healthy), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)">Healthy<br/></a>
      </li>
    }
    @if(testsSummary.warnCount > 0) {
      <li @if(testStatusOpt == Some(TestStatus.Warning)){ class="active" }>
        <a href="@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Warning), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)">Warning<br/></a>
      </li>
    }
    @if(testsSummary.failCount > 0) {
      <li @if(testStatusOpt == Some(TestStatus.Broken)){ class="active" }>
        <a href="@routes.Application.tests(configuration = Some(configuration), status = Some(TestStatus.Broken), name = nameOpt, group = groupOpt, sort = sortOpt, descending = descendingOpt)">Broken</a>
      </li>
    }
  </ul>

  <form style="margin-bottom: 0px; display: inline" id="testActionForm" action="nope" method="post">
    <input type="hidden" name="previousURL" value="@request.uri"/>
    <table class="table table-striped table-bordered table-hover table-condensed">
      <thead>
        <tr>
          <th style="text-align: center"><input class="testCheckbox" id="selectAll" type="checkbox" title="Select all"/></th>
          <th class="pass-fail-col">Status</th>
          <th class="pass-fail-col" style="white-space: nowrap">Weather @sortLink(Sort.Weather)</th>
          <th class="group-col">Group @sortLink(Sort.Group)</th>
          <th class="name-col">Name @sortLink(Sort.Name)</th>
          <th class="duration-col">Average duration @sortLink(Sort.Duration)</th>
          <th class="consecutive-failures-col">Consecutive failures @sortLink(Sort.ConsecutiveFailures)</th>
          <th class="failing-since-col">Started failing @sortLink(Sort.StartedFailing)</th>
          <th class="last-passfail-col">Last passed @sortLink(Sort.LastPassed)</th>
          <th class="last-passfail-col">Last failed @sortLink(Sort.LastFailed)</th>
      </thead>
      <tbody>
        @for(test <- tests) {
          <tr class="test-row">
            <td style="text-align: center; width: 50px"><input class="testCheckbox" type="checkbox" name="selectedTest" value="@test.id"/></td>
            <td class="pass-fail-cell">@for(icon <- test.ballIconOpt){<a href="@routes.Application.test(test.id, configuration = Some(configuration))"><img src="@routes.Assets.at("images/" + icon)"/></a>}</td>
            <td class="pass-fail-cell">@for(weatherInfo <- test.weatherInfoOpt){<img title="@weatherInfo.passRate" src="@routes.Assets.at("images/" + weatherInfo.iconPath)"/>}</td>
            <td class="center-vert">@for(group <- test.groupOpt) {<a href="@routes.Application.tests(configuration = Some(configuration), status = testStatusOpt, name = nameOpt, group = Some(group.full), sort = sortOpt, descending = descendingOpt)"><span title="@group.full">@group.abbreviate(maxLength = 35)</span></a>}</td>
            <td class="center-vert"><a class="test-link" href="@routes.Application.test(test.id, configuration = Some(configuration))" title="@test.name.full">@test.name.abbreviate(maxLength = 40)</a></td>
            <td class="duration-cell">@for(duration <- test.medianDurationOpt){@duration}</td>
            <td class="consecutive-failures-cell">@for(consecutiveFailures <- test.consecutiveFailuresOpt){@consecutiveFailures}</td>            
            <td class="failing-since-cell">@for(failingSince <- test.failingSinceOpt){<span title="@failingSince.absolute">@failingSince.relative</span>}</td>
            <td class="last-passfail-cell">@for((executionId, time) <- test.lastPassedExecutionOpt){<a class="last-passed-link" href="@routes.Application.execution(executionId)" title="@time.absolute">@time.relative</a>}</td>
            <td class="last-passfail-cell">@for((executionId, time) <- test.lastFailedExecutionOpt){<a href="@routes.Application.execution(executionId)" title="@time.absolute">@time.relative</a>}</td>
          </tr>
         }
      <tbody>
    </table>
  </form>

  @testsPaginationWidget

  } else {

    <div class="panel panel-info">
      <div class="panel-heading">No results found</div>
      <div class="panel-body">
        No tests found matching your filters.
      </div>
    </div>

  }
  
}
